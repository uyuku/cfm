<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoTrack</title>
    <link href="https://cdn.jsdelivr.net/npm/beercss@3.9.7/dist/cdn/beer.min.css" rel="stylesheet" />
    <script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.9.7/dist/cdn/beer.min.js"></script>
    <script type="module"
        src="https://cdn.jsdelivr.net/npm/material-dynamic-colors@1.1.2/dist/cdn/material-dynamic-colors.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/material-icons@1.13.12/iconfont/material-icons.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.js"></script>

    <style>
        :root {
            --font: 'Quicksand', sans-serif;
        }

        :root,
        body.light {
            --primary: #006e1c;
            --on-primary: #ffffff;
            --primary-container: #94f990;
            --on-primary-container: #002204;
            --secondary: #52634f;
            --on-secondary: #ffffff;
            --secondary-container: #d5e8cf;
            --on-secondary-container: #111f0f;
            --tertiary: #38656a;
            --on-tertiary: #ffffff;
            --tertiary-container: #bcebf0;
            --on-tertiary-container: #002023;
            --error: #ba1a1a;
            --on-error: #ffffff;
            --error-container: #ffdad6;
            --on-error-container: #410002;
            --background: #fcfdf6;
            --on-background: #1a1c19;
            --surface: #f9faf4;
            --on-surface: #1a1c19;
            --surface-variant: #dee5d8;
            --on-surface-variant: #424940;
            --outline: #72796f;
            --outline-variant: #c2c9bd;
            --shadow: #000000;
            --scrim: #000000;
            --inverse-surface: #2f312d;
            --inverse-on-surface: #f0f1eb;
            --inverse-primary: #78dc77;
            --surface-dim: #dadad4;
            --surface-bright: #f9faf4;
            --surface-container-lowest: #ffffff;
            --surface-container-low: #f3f4ee;
            --surface-container: #eeeee8;
            --surface-container-high: #e8e9e2;
            --surface-container-highest: #e2e3dd;
        }

        :root,
        body.dark {
            --primary: #78dc77;
            --on-primary: #00390a;
            --primary-container: #005313;
            --on-primary-container: #94f990;
            --secondary: #baccb3;
            --on-secondary: #253423;
            --secondary-container: #3b4b38;
            --on-secondary-container: #d5e8cf;
            --tertiary: #a0cfd4;
            --on-tertiary: #00363b;
            --tertiary-container: #1f4d52;
            --on-tertiary-container: #bcebf0;
            --error: #ffb4ab;
            --on-error: #690005;
            --error-container: #93000a;
            --on-error-container: #ffb4ab;
            --background: #1a1c19;
            --on-background: #e2e3dd;
            --surface: #121411;
            --on-surface: #e2e3dd;
            --surface-variant: #424940;
            --on-surface-variant: #c2c9bd;
            --outline: #8c9388;
            --outline-variant: #424940;
            --shadow: #000000;
            --scrim: #000000;
            --inverse-surface: #e2e3dd;
            --inverse-on-surface: #2f312d;
            --inverse-primary: #006e1c;
            --surface-dim: #121411;
            --surface-bright: #383a36;
            --surface-container-lowest: #0c0f0c;
            --surface-container-low: #1a1c19;
            --surface-container: #1e201d;
            --surface-container-high: #282b27;
            --surface-container-highest: #333531;
        }

        .field label small {
            font-size: 0.8em;
            opacity: 0.7;
            margin-left: 5px;
        }

        .result-card-custom {
            margin-bottom: var(--space);
            box-shadow: 0 4px 12px color-mix(in srgb, var(--primary) 30%, transparent);
        }

        .result-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 8px 0;
        }

        .result-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 220px;
            border-radius: 0 !important;
            margin-top: var(--space);
            margin-bottom: var(--space);
        }

        .eco-list-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            transition: transform 0.15s ease;
        }

        .eco-list-item:hover {
            transform: translateX(4px);
        }

        .eco-list-item i {
            margin-right: 12px;
            flex-shrink: 0;
        }

        .empty-state i {
            font-size: 48px;
            opacity: 0.5;
            margin-bottom: 12px;
        }

        .app-logo {
            font-weight: 700;
            font-size: 1.4rem;
        }

        .app-logo i {
            margin-right: 8px;
        }

        .table-card {
            overflow: hidden;
        }

        .responsive-table {
            overflow-x: auto;
            width: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table thead th {
            background-color: var(--primary-container);
            color: var(--on-primary-container);
            text-align: left;
            padding: 14px 16px;
            border-bottom: 2px solid var(--primary);
            position: sticky;
            top: 0;
            z-index: 1;
            white-space: nowrap;
        }

        table tbody td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--outline-variant);
            vertical-align: middle;
        }

        table.stripes tbody tr:last-child td {
            border-bottom: none;
        }

        footer {
            margin-top: var(--space-large);
            padding: var(--space);
            text-align: center;
            font-size: 0.9rem;
            color: var(--on-surface-variant);
            background-color: var(--surface-container-low);
        }

        h5 b {
             font-weight: 600; /* BeerCSS uses 600 for h5, adjust if needed */
        }
    </style>
</head>

<body class="light">
    <header class="surface elevate1">
        <nav class="row middle-align">
            <button class="circle transparent large" onclick="uiUtils.toggleTheme()" data-ui="#theme-icon">
                <i id="theme-icon" class="material-icons">dark_mode</i>
                <div class="tooltip bottom">Toggle Theme</div>
            </button>
            <div class="app-logo max center-align row middle-align">
                <i class="material-icons primary-text">eco</i>
                <span>EcoTrack</span>
            </div>
            <button class="circle transparent large" onclick="window.calculator.resetCalculator()">
                <i class="material-icons">refresh</i>
                <div class="tooltip bottom">Reset All History</div>
            </button>
        </nav>
    </header>

    <main class="container responsive medium-padding">
        <div class="grid">
            <div class="s12 m5 l4">
                <div class="card surface medium-round medium-padding border bottom-margin">
                    <h5 class="row middle-align primary-text"><i class="material-icons">calculate</i><b>Calculate Impact</b></h5>

                    <div class="field label border medium-round bottom-margin">
                        <select id="category">
                            <option value="" disabled selected>Select Category...</option>
                        </select>
                        <label for="category">Category</label>
                    </div>

                    <div class="field label border medium-round bottom-margin">
                        <select id="item">
                            <option value="" disabled selected>Select Item...</option>
                        </select>
                        <label for="item">Item</label>
                    </div>

                    <div class="field label border medium-round bottom-margin">
                        <input type="number" id="value" step="any" min="0.01">
                        <label for="value">Amount <small id="amount-unit"></small></label>
                    </div>

                    <div id="error-message"
                        class="error-container medium-round small-padding bottom-margin row middle-align"
                        style="display: none;">
                        <i class="material-icons">error_outline</i>
                        <span class="max left-margin"></span>
                    </div>

                    <div class="row middle-align no-wrap">
                        <button id="calculate-btn" class="primary medium-round">
                            <i class="material-icons">eco</i>
                            <span>Calculate</span>
                        </button>
                        <button id="reset-form-btn" class="secondary circle large medium-round left-margin"
                            title="Clear Inputs">
                            <i>clear</i>
                        </button>
                    </div>

                     <!-- Message Area -->
                    <div id="result" class="surface-variant medium-round small-padding top-margin bottom-margin row middle-align" style="display: flex;">
                        <i class="material-icons right-margin">info_outline</i>
                        <span>Ready to calculate.</span>
                    </div>
                    <!-- End Message Area -->

                    <div class="divider horizontal bottom-margin"></div> <!-- Adjusted margin -->

                    <div class="result-card-custom primary medium-round medium-padding center-align">
                        <div class="result-label">Total Footprint</div>
                        <div id="total-emissions" class="result-value">0.00</div>
                        <div class="result-label">kg CO₂e</div>
                    </div>
                </div>
            </div>

            <div class="s12 m7 l8">
                <div class="grid">
                    <div class="s12 l6">
                        <div class="card surface medium-round medium-padding border bottom-margin">
                            <h5 class="row middle-align primary-text"><i class="material-icons">pie_chart</i><b>Breakdown by Item</b></h5>
                            <div id="pie-empty" class="empty-state center-align large-padding" style="display: block;">
                                <i class="material-icons primary-text">pie_chart_outline</i>
                                <p class="secondary-text">No data yet</p>
                            </div>
                            <div class="chart-container">
                                <canvas id="pie-chart" style="display: none;"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="s12 l6">
                        <div class="card surface medium-round medium-padding border bottom-margin">
                            <h5 class="row middle-align primary-text"><i class="material-icons">bar_chart</i><b>By Category</b></h5>
                            <div id="bar-empty" class="empty-state center-align large-padding" style="display: block;">
                                <i class="material-icons primary-text">insert_chart_outlined</i>
                                <p class="secondary-text">No data yet</p>
                            </div>
                            <div class="chart-container">
                                <canvas id="bar-chart" style="display: none;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card surface medium-round medium-padding border bottom-margin">
                    <h5 class="row middle-align primary-text"><i class="material-icons">tips_and_updates</i><b>Eco Tips</b></h5>
                    <div id="reduction-tips-list" class="top-margin">
                        <div class="empty-state center-align large-padding">
                            <i class="material-icons primary-text">nature_people</i>
                            <p class="secondary-text">Calculate emissions to see relevant tips!</p>
                        </div>
                    </div>
                </div>

                <div class="card surface medium-round medium-padding border bottom-margin">
                    <h5 class="row middle-align primary-text"><i class="material-icons">compare_arrows</i><b>Equivalents</b></h5>
                    <p class="secondary-text bottom-margin">Your total footprint is similar to:</p>
                    <div id="equivalents-list" class="top-margin">
                        <div class="empty-state center-align large-padding">
                            <i class="material-icons primary-text">insights</i>
                            <p class="secondary-text">Calculate emissions to see equivalents.</p>
                        </div>
                    </div>
                </div>

                <div class="card surface medium-round medium-padding border bottom-margin table-card">
                    <h5 class="row middle-align primary-text"><i class="material-icons">history</i><b>History</b></h5>

                    <div class="responsive-table top-margin">
                        <table id="history-table" class="stripes">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Item</th>
                                    <th>Amount</th>
                                    <th>Unit</th>
                                    <th>kg CO₂e</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                                <tr id="history-empty" style="display: none;">
                                    <td colspan="5">
                                        <div class="empty-state center-align large-padding">
                                            <i class="material-icons primary-text">receipt_long</i>
                                            <p class="secondary-text">No calculations recorded yet.</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <footer class="surface">
        <p>Made by Necdet Ömer BARUT for CEV469</p>
    </footer>

    <script>
        const uiUtils = {
            toggleTheme: () => {
                const body = document.body;
                const icon = document.getElementById('theme-icon');
                const isDark = body.classList.contains('dark');
                if (isDark) {
                    body.classList.replace("dark", "light");
                    icon.textContent = "dark_mode";
                    localStorage.setItem('theme', 'light');
                } else {
                    body.classList.replace("light", "dark");
                    icon.textContent = "light_mode";
                    localStorage.setItem('theme', 'dark');
                }
                if (window.calculator) {
                    window.calculator.updateChartThemes();
                }
            },
            applyPersistedTheme: () => {
                const persistedTheme = localStorage.getItem('theme');
                const body = document.body;
                const icon = document.getElementById('theme-icon');
                if (persistedTheme === 'dark') {
                    if (!body.classList.contains('dark')) body.classList.add('dark');
                    if (body.classList.contains('light')) body.classList.remove('light');
                    icon.textContent = "light_mode";
                } else {
                    if (body.classList.contains('dark')) body.classList.remove('dark');
                    if (!body.classList.contains('light')) body.classList.add('light');
                    icon.textContent = "dark_mode";
                }
                setTimeout(() => {
                    if (window.calculator) {
                        window.calculator.updateChartThemes();
                    }
                }, 50);
            }
        };

        class CarbonCalculator {
            constructor() {
                this.EMISSION_FACTORS = {
                    "Transportation (Ground)": {
                        "Gasoline Car (Average)": { factor: 0.192, unit: "km", tip_icon: "directions_car" },
                        "Gasoline Car (Large/SUV)": { factor: 0.280, unit: "km", tip_icon: "minor_crash" },
                        "Gasoline Car (Small/Efficient)": { factor: 0.150, unit: "km", tip_icon: "electric_rickshaw" },
                        "Diesel Car (Average)": { factor: 0.171, unit: "km", tip_icon: "directions_car_filled" },
                        "Hybrid Car (HEV)": { factor: 0.120, unit: "km", tip_icon: "electric_car" },
                        "Electric Car (EV - Avg Grid)": { factor: 0.049, unit: "km", tip_icon: "electric_car" },
                        "Motorcycle (Average)": { factor: 0.113, unit: "km", tip_icon: "two_wheeler" },
                        "Bus (Local/City)": { factor: 0.105, unit: "km", tip_icon: "directions_bus" },
                        "Bus (Coach/Intercity)": { factor: 0.028, unit: "km", tip_icon: "departure_board" },
                        "Train (National Rail/Intercity)": { factor: 0.041, unit: "km", tip_icon: "train" },
                        "Train (Light Rail/Tram/Subway)": { factor: 0.035, unit: "km", tip_icon: "tram" },
                        "Train (High-Speed Rail)": { factor: 0.004, unit: "km", tip_icon: "train" },
                        "Ferry (Foot Passenger)": { factor: 0.019, unit: "km", tip_icon: "directions_boat" },
                        "Ferry (Car Passenger)": { factor: 0.120, unit: "km", tip_icon: "directions_boat" }
                    },
                    "Transportation (Air)": {
                        "Short Haul Flight (<3700km, Economy)": { factor: 0.246, unit: "km", tip_icon: "flight_takeoff" },
                        "Short Haul Flight (<3700km, Business)": { factor: 0.350, unit: "km", tip_icon: "flight_class" },
                        "Long Haul Flight (>=3700km, Economy)": { factor: 0.150, unit: "km", tip_icon: "flight" },
                        "Long Haul Flight (>=3700km, Business)": { factor: 0.430, unit: "km", tip_icon: "flight_class" },
                        "Long Haul Flight (>=3700km, First)": { factor: 0.600, unit: "km", tip_icon: "airline_seat_flat" },
                        "Domestic Flight (Avg, Economy)": { factor: 0.255, unit: "km", tip_icon: "connecting_airports" }
                    },
                    "Home Energy": {
                        "Electricity (Avg Grid Mix)": { factor: 0.233, unit: "kWh", tip_icon: "electrical_services" },
                        "Electricity (100% Renewable Tariff)": { factor: 0.000, unit: "kWh", tip_icon: "wind_power" },
                        "Natural Gas": { factor: 0.184, unit: "kWh", tip_icon: "local_fire_department" },
                        "Heating Oil": { factor: 2.68, unit: "litre", tip_icon: "oil_barrel" },
                        "LPG (Propane)": { factor: 1.51, unit: "litre", tip_icon: "propane_tank" },
                        "Wood Logs (Dried, Seasoned)": { factor: 0.018, unit: "kg", tip_icon: "forest" },
                        "Wood Pellets (from waste)": { factor: 0.01, unit: "kg", tip_icon: "grain" }
                    },
                    "Food (Solid)": {
                        "Beef (Beef Herd)": { factor: 60.0, unit: "kg", tip_icon: "kebab_dining" },
                        "Lamb & Mutton": { factor: 39.2, unit: "kg", tip_icon: "food_bank" },
                        "Pork": { factor: 12.1, unit: "kg", tip_icon: "set_meal" },
                        "Chicken": { factor: 6.9, unit: "kg", tip_icon: "egg_alt" },
                        "Turkey": { factor: 10.9, unit: "kg", tip_icon: "egg" },
                        "Fish (Farmed Salmon)": { factor: 11.9, unit: "kg", tip_icon: "set_meal" },
                        "Fish (Wild Caught Cod/Haddock - Trawled)": { factor: 5.0, unit: "kg", tip_icon: "phishing" },
                        "Fish (Wild Caught Tuna - Various methods)": { factor: 6.1, unit: "kg", tip_icon: "set_meal" },
                        "Shrimp/Prawns (Farmed)": { factor: 26.8, unit: "kg", tip_icon: "water" },
                        "Cheese (Hard, e.g., Cheddar)": { factor: 13.5, unit: "kg", tip_icon: "lunch_dining" },
                        "Eggs (Chicken)": { factor: 0.4, unit: "unit", tip_icon: "egg" },
                        "Butter": { factor: 11.0, unit: "kg", tip_icon: "bakery_dining" },
                        "Yogurt (Dairy)": { factor: 2.2, unit: "kg", tip_icon: "icecream" },
                        "Rice (Paddy Grown)": { factor: 2.7, unit: "kg", tip_icon: "ramen_dining" },
                        "Potatoes": { factor: 0.2, unit: "kg", tip_icon: "spa" },
                        "Bread (Wheat)": { factor: 0.8, unit: "kg", tip_icon: "bakery_dining" },
                        "Pasta (Dried Wheat)": { factor: 1.0, unit: "kg", tip_icon: "restaurant" },
                        "Lentils (Dried)": { factor: 0.9, unit: "kg", tip_icon: "bubble_chart" },
                        "Beans (Dried)": { factor: 0.8, unit: "kg", tip_icon: "scatter_plot" },
                        "Tofu (Soy Based)": { factor: 2.0, unit: "kg", tip_icon: "emoji_food_beverage" },
                        "Nuts (Mixed Average)": { factor: 2.3, unit: "kg", tip_icon: "nuts" },
                        "Fruits (Seasonal, Local)": { factor: 0.4, unit: "kg", tip_icon: "park" },
                        "Vegetables (Seasonal, Local)": { factor: 0.4, unit: "kg", tip_icon: "grass" },
                        "Tomatoes (Greenhouse Grown)": { factor: 2.9, unit: "kg", tip_icon: "emoji_nature" },
                        "Tomatoes (Imported Field Grown)": { factor: 1.1, unit: "kg", tip_icon: "local_florist" },
                        "Berries (Imported, Air-Freight)": { factor: 11.0, unit: "kg", tip_icon: "flight_land" },
                        "Bananas": { factor: 0.7, unit: "kg", tip_icon: "emoji_food_beverage" },
                        "Chocolate (Dark)": { factor: 20.0, unit: "kg", tip_icon: "cake" },
                        "Chocolate (Milk)": { factor: 15.0, unit: "kg", tip_icon: "cake" },
                        "Pet Food - Dry Dog Food (Average)": { factor: 4.0, unit: "kg", tip_icon: "pets" },
                        "Pet Food - Dry Cat Food (Average)": { factor: 3.5, unit: "kg", tip_icon: "pets" },
                        "Pet Food - Wet Food (Can/Pouch)": { factor: 7.0, unit: "kg", tip_icon: "catching_pokemon" }
                    },
                    "Drinks": {
                        "Milk (Dairy)": { factor: 1.9, unit: "litre", tip_icon: "local_cafe" },
                        "Oat Milk": { factor: 0.9, unit: "litre", tip_icon: "breakfast_dining" },
                        "Soy Milk": { factor: 1.0, unit: "litre", tip_icon: "ramen_dining" },
                        "Almond Milk": { factor: 0.7, unit: "litre", tip_icon: "scatter_plot" },
                        "Coffee (Grounds for Brewed)": { factor: 17.0, unit: "kg", tip_icon: "coffee_maker" },
                        "Tea (Leaves/Bags)": { factor: 10.0, unit: "kg", tip_icon: "emoji_food_beverage" },
                        "Beer (Draught/Can/Bottle)": { factor: 0.8, unit: "litre", tip_icon: "sports_bar" },
                        "Wine": { factor: 1.6, unit: "litre", tip_icon: "wine_bar" },
                        "Soda (Canned/Bottled)": { factor: 0.5, unit: "litre", tip_icon: "local_drink" },
                        "Bottled Water (Plastic Bottle)": { factor: 0.15, unit: "litre", tip_icon: "local_drink" }
                    },
                    "Waste": {
                        "Landfill Waste (Mixed MSW)": { factor: 0.58, unit: "kg", tip_icon: "delete" },
                        "Recycled Waste (Mixed Dry Recyclables)": { factor: 0.02, unit: "kg", tip_icon: "recycling" },
                        "Composted Waste (Food/Garden)": { factor: 0.01, unit: "kg", tip_icon: "compost" },
                        "Incineration (with energy recovery)": { factor: 0.20, unit: "kg", tip_icon: "fireplace" },
                        "Incineration (without energy recovery)": { factor: 0.40, unit: "kg", tip_icon: "whatshot" }
                    },
                    "Water": {
                        "Tap Water Usage (Supply & Treatment)": { factor: 0.344, unit: "m³", tip_icon: "water_drop" }
                    },
                    "Clothing & Textiles": {
                        "Cotton T-Shirt": { factor: 7.0, unit: "item", tip_icon: "checkroom" },
                        "Polyester T-Shirt": { factor: 5.5, unit: "item", tip_icon: "checkroom" },
                        "Jeans (Cotton Denim)": { factor: 33.4, unit: "item", tip_icon: "checkroom" },
                        "Sneakers/Trainers (Mixed Materials)": { factor: 14.0, unit: "pair", tip_icon: "footprint" },
                        "Wool Sweater": { factor: 40.0, unit: "item", tip_icon: "styler" }
                    }
                };

                this.REDUCTION_TIPS = {
                    "Transportation (Ground)": [
                        { icon: "directions_walk", tip: "Walk or cycle short distances." },
                        { icon: "directions_bus", tip: "Use public transport more often." },
                        { icon: "electric_car", tip: "Consider lower-emission vehicles (EV, hybrid)." },
                        { icon: "train", tip: "Choose train over car for medium-distance travel." }
                    ],
                    "Transportation (Air)": [
                        { icon: "flight", tip: "Fly less often, especially short haul." },
                        { icon: "luggage", tip: "Pack lighter to reduce fuel consumption." },
                        { icon: "flight_class", tip: "Fly economy class." }
                    ],
                    "Home Energy": [
                        { icon: "lightbulb", tip: "Switch to LED lighting." },
                        { icon: "thermostat", tip: "Adjust thermostat settings seasonally." },
                        { icon: "power_off", tip: "Unplug devices or use smart strips." }
                    ],
                    "Food (Solid)": [
                        { icon: "restaurant_menu", tip: "Reduce consumption of red meat (beef, lamb)." },
                        { icon: "eco", tip: "Incorporate more plant-based meals." },
                        { icon: "shopping_basket", tip: "Buy local and seasonal produce when possible." },
                        { icon: "no_food", tip: "Minimize food waste." },
                        { icon: "pets", tip: "Choose pet foods with lower-impact ingredients if possible." }
                    ],
                    "Drinks": [
                        { icon: "water_drop", tip: "Drink tap water instead of bottled water." },
                        { icon: "local_cafe", tip: "Reduce dairy milk consumption or switch to plant-based alternatives." },
                        { icon: "recycling", tip: "Recycle beverage containers." }
                    ],
                    "Waste": [
                        { icon: "recycling", tip: "Maximize recycling efforts." },
                        { icon: "compost", tip: "Compost organic waste if possible." },
                        { icon: "shopping_bag", tip: "Reduce single-use items (bags, bottles)." }
                    ],
                    "Water": [
                        { icon: "shower", tip: "Take shorter showers." },
                        { icon: "water_drop", tip: "Fix leaks promptly." },
                        { icon: "grass", tip: "Use water-wise gardening techniques." }
                    ],
                    "Clothing & Textiles": [
                        { icon: "shopping_bag", tip: "Buy less, choose quality." },
                        { icon: "recycling", tip: "Repair, donate, or recycle old clothes." },
                        { icon: "wash", tip: "Wash clothes less often and in cold water." }
                    ]
                };

                this.EQUIVALENTS = [
                    { icon: "phone_iphone", min: 0.1, max: 2, text: "Charging a smartphone ~250 times" },
                    { icon: "tv", min: 1, max: 10, text: "Watching LED TV for ~100 hours" },
                    { icon: "directions_car", min: 5, max: 20, text: "Driving a gasoline car ~25-100 km" },
                    { icon: "forest", min: 15, max: 50, text: "Carbon sequestered by 1-3 tree seedlings grown for 10 years" },
                    { icon: "kebab_dining", min: 25, max: 100, text: "Producing ~0.4-1.7 kg of beef" },
                    { icon: "local_shipping", min: 50, max: 200, text: "Driving a gasoline car ~250-1000 km" },
                    { icon: "flight_takeoff", min: 100, max: 500, text: "A short-haul flight (~400-2000 km, economy)" },
                    { icon: "wb_sunny", min: 500, max: 1500, text: "Carbon sequestered by ~0.2-0.6 hectares of US forest in one year" },
                    { icon: "flight", min: 1000, max: 5000, text: "A long-haul flight round-trip (~6700-33000 km, economy)" },
                ];

                this.chartColorPalette = ['#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722', '#795548', '#9E9E9E', '#607D8B', '#00BCD4', '#03A9F4', '#2196F3', '#3F51B5', '#673AB7', '#9C27B0', '#E91E63', '#F44336'];
                this.history = this.loadHistory();
                this.totalEmission = 0;
                this.categorySelect = document.getElementById("category");
                this.itemSelect = document.getElementById("item");
                this.valueInput = document.getElementById("value");
                this.amountUnitSpan = document.getElementById("amount-unit");
                this.resultDiv = document.getElementById("result"); // Reference to the message area
                this.totalEmissionsDisplay = document.getElementById("total-emissions");
                this.errorMessage = document.getElementById("error-message");
                this.errorTextSpan = this.errorMessage.querySelector("span");
                this.historyTableBody = document.getElementById("history-table-body");
                this.historyEmptyRow = document.getElementById("history-empty");
                this.reductionTipsList = document.getElementById("reduction-tips-list");
                this.equivalentsList = document.getElementById("equivalents-list");
                this.calculateBtn = document.getElementById("calculate-btn");
                this.resetFormBtn = document.getElementById("reset-form-btn");
                this.pieEmpty = document.getElementById("pie-empty");
                this.barEmpty = document.getElementById("bar-empty");
                this.pieCanvas = document.getElementById("pie-chart");
                this.barCanvas = document.getElementById("bar-chart");
                this.pieChart = null;
                this.barChart = null;

                this.init();
            }

            init() {
                this.populateCategories();
                this.setupEventListeners();
                this.initCharts();
                uiUtils.applyPersistedTheme();
                this.recalculateTotal();
                this.updateUI();
                 this.clearResult(); // Ensure initial state is "Ready"
            }

            populateCategories() {
                this.categorySelect.options.length = 1;
                Object.keys(this.EMISSION_FACTORS).sort().forEach(category => {
                    this.categorySelect.add(new Option(category, category));
                });
                if (typeof ui === 'function') {
                    setTimeout(() => ui(this.categorySelect), 0);
                }
            }

            populateItems(category) {
                this.itemSelect.options.length = 1;
                this.itemSelect.value = "";
                this.amountUnitSpan.textContent = "";
                if (category && this.EMISSION_FACTORS[category]) {
                    Object.keys(this.EMISSION_FACTORS[category]).sort().forEach(item => {
                        this.itemSelect.add(new Option(item, item));
                    });
                }
                if (typeof ui === 'function') {
                    setTimeout(() => ui(this.itemSelect), 0);
                }
            }

            updateAmountUnit(category, item) {
                if (category && item && this.EMISSION_FACTORS[category]?.[item]) {
                    this.amountUnitSpan.textContent = `(${this.EMISSION_FACTORS[category][item].unit})`;
                } else {
                    this.amountUnitSpan.textContent = "";
                }
            }

            setupEventListeners() {
                this.categorySelect.addEventListener("change", (e) => {
                    const category = e.target.value;
                    this.populateItems(category);
                    this.updateAmountUnit(category, this.itemSelect.value);
                    this.hideError(); this.clearResult();
                });
                this.itemSelect.addEventListener("change", (e) => {
                    this.updateAmountUnit(this.categorySelect.value, e.target.value);
                    this.hideError(); this.clearResult();
                });
                this.valueInput.addEventListener("input", () => {
                    this.hideError(); this.clearResult();
                });
                this.calculateBtn.addEventListener("click", () => this.calculateAndAddEmission());
                this.resetFormBtn.addEventListener("click", () => this.resetForm());
            }

            calculateAndAddEmission() {
                const category = this.categorySelect.value;
                const item = this.itemSelect.value;
                const valueStr = this.valueInput.value;
                const value = parseFloat(valueStr);
                if (!category) return this.showError("Please select a category.");
                if (!item) return this.showError("Please select an item.");
                if (valueStr.trim() === "" || isNaN(value)) return this.showError("Please enter a valid amount.");
                if (value <= 0) return this.showError("Amount must be positive.");
                this.hideError();
                const factorData = this.EMISSION_FACTORS[category]?.[item];
                if (!factorData) return this.showError("Calculation error. Factor not found.");
                const { factor, unit } = factorData;
                const emission = factor * value;
                const id = Date.now().toString();
                this.history.push({ id, category, item, value, unit, emission });
                this.recalculateTotal();
                this.saveHistory();
                this.updateUI();
                this.showResult(); // Simplified: No need to pass details for the simple message
            }

            recalculateTotal() {
                this.totalEmission = this.history.reduce((sum, entry) => sum + entry.emission, 0);
            }

            updateUI() {
                this.totalEmissionsDisplay.textContent = this.totalEmission.toFixed(2);
                this.updateHistoryTable();
                this.updateCharts();
                this.updateReductionTips();
                this.updateEquivalents();
                this.checkEmptyStates();
            }

            updateHistoryTable() {
                while (this.historyTableBody.firstChild && this.historyTableBody.firstChild !== this.historyEmptyRow) {
                    this.historyTableBody.removeChild(this.historyTableBody.firstChild);
                }
                const hasHistory = this.history.length > 0;
                this.historyEmptyRow.style.display = hasHistory ? 'none' : 'table-row';

                if (hasHistory) {
                    const sortedHistory = [...this.history].sort((a, b) => parseInt(b.id) - parseInt(a.id));
                    sortedHistory.forEach(item => {
                        const row = this.historyTableBody.insertRow(0);
                        row.innerHTML = `
                            <td>${item.category}</td>
                            <td>${item.item}</td>
                            <td>${item.value.toLocaleString()}</td>
                            <td>${item.unit}</td>
                            <td>${item.emission.toFixed(2)}</td>
                        `;
                    });
                }
            }

            updateCharts() {
                if (!this.pieChart || !this.barChart) return;
                const hasData = this.history.length > 0;
                const emissionsByItem = {};
                const emissionsByCategory = {};
                this.history.forEach(item => {
                    const itemLabel = `${item.item} (${item.category.substring(0, 3)})`;
                    emissionsByItem[itemLabel] = (emissionsByItem[itemLabel] || 0) + item.emission;
                    emissionsByCategory[item.category] = (emissionsByCategory[item.category] || 0) + item.emission;
                });
                const pieLabels = Object.keys(emissionsByItem);
                const pieData = Object.values(emissionsByItem);
                const pieColors = pieLabels.map((_, index) => this.chartColorPalette[index % this.chartColorPalette.length]);
                this.pieChart.data.labels = pieLabels;
                this.pieChart.data.datasets[0].data = pieData;
                this.pieChart.data.datasets[0].backgroundColor = pieColors;
                this.pieChart.data.datasets[0].borderColor = getComputedStyle(document.body).getPropertyValue('--surface').trim();
                this.pieChart.update();

                const barLabels = Object.keys(emissionsByCategory);
                const barData = Object.values(emissionsByCategory);
                const barColors = barLabels.map((_, index) => this.chartColorPalette[index % this.chartColorPalette.length]);
                this.barChart.data.labels = barLabels;
                this.barChart.data.datasets[0].data = barData;
                this.barChart.data.datasets[0].backgroundColor = barColors;
                this.barChart.data.datasets[0].borderColor = barColors.map(color => this.adjustColor(color, -20));
                this.barChart.update();

                this.checkEmptyStates();
            }

            updateChartThemes() {
                if (!this.pieChart || !this.barChart) return;
                const getCssVar = (varName) => getComputedStyle(document.body).getPropertyValue(varName).trim();
                const legendColor = getCssVar('--on-surface');
                const gridColor = getCssVar('--outline');
                const tickColor = getCssVar('--on-surface-variant');
                const surfaceColor = getCssVar('--surface');

                if (this.pieChart.options.plugins.legend) {
                    this.pieChart.options.plugins.legend.labels.color = legendColor;
                }
                this.pieChart.data.datasets[0].borderColor = surfaceColor;
                const pieLabels = this.pieChart.data.labels || [];
                const pieColors = pieLabels.map((_, index) => this.chartColorPalette[index % this.chartColorPalette.length]);
                this.pieChart.data.datasets[0].backgroundColor = pieColors;
                this.pieChart.update();

                if (this.barChart.options.plugins.legend) {
                    this.barChart.options.plugins.legend.labels.color = legendColor;
                }
                if (this.barChart.options.scales.y) {
                    this.barChart.options.scales.y.grid.color = gridColor;
                    this.barChart.options.scales.y.ticks.color = tickColor;
                }
                if (this.barChart.options.scales.x) {
                    this.barChart.options.scales.x.grid.display = false;
                    this.barChart.options.scales.x.ticks.color = tickColor;
                }
                const barLabels = this.barChart.data.labels || [];
                const barColors = barLabels.map((_, index) => this.chartColorPalette[index % this.chartColorPalette.length]);
                this.barChart.data.datasets[0].backgroundColor = barColors;
                this.barChart.data.datasets[0].borderColor = barColors.map(color => this.adjustColor(color, -20));
                this.barChart.update();
            }

            adjustColor(color, amount) {
                try {
                    return '#' + color.replace(/^#/, '').replace(/../g, c => ('0' + Math.min(255, Math.max(0, parseInt(c, 16) + amount)).toString(16)).substr(-2));
                } catch (e) {
                    console.warn("Could not adjust color:", color, e);
                    return color;
                }
            }

            renderTipOrEquivalentItem(itemData) {
                const listElement = document.createElement("div");
                listElement.className = `eco-list-item surface-variant medium-round small-padding row middle-align`;
                listElement.innerHTML = ` <i class="material-icons primary-text">${itemData.icon}</i> <span class="max left-margin">${itemData.text || itemData.tip}</span>`;
                return listElement;
            }

            updateReductionTips() {
                this.reductionTipsList.innerHTML = "";
                const tipsContainer = this.reductionTipsList;
                if (this.history.length === 0) {
                    return this.renderEmptyState(tipsContainer, "nature_people", "Calculate emissions to see relevant tips!");
                }

                const emissionsByCategory = {};
                this.history.forEach(item => {
                    emissionsByCategory[item.category] = (emissionsByCategory[item.category] || 0) + item.emission;
                });
                const sortedCategories = Object.keys(emissionsByCategory).sort((a, b) => emissionsByCategory[b] - emissionsByCategory[a]);

                const tipsToShow = new Set();
                const maxTips = 5;

                sortedCategories.forEach(category => {
                    if (this.REDUCTION_TIPS[category] && tipsToShow.size < maxTips) {
                        this.REDUCTION_TIPS[category].forEach(tip => {
                            if (tipsToShow.size < maxTips) tipsToShow.add(JSON.stringify(tip));
                        });
                    }
                });

                if (tipsToShow.size < maxTips) {
                    Object.values(this.REDUCTION_TIPS).flat().forEach(tip => {
                        if (tipsToShow.size < maxTips) tipsToShow.add(JSON.stringify(tip));
                    });
                }

                if (tipsToShow.size === 0) {
                    return this.renderEmptyState(tipsContainer, "help_outline", "No specific tips available yet.");
                }

                tipsToShow.forEach(tipString => {
                    try {
                        const tip = JSON.parse(tipString);
                        const listItem = this.renderTipOrEquivalentItem(tip);
                        tipsContainer.appendChild(listItem);
                    } catch (e) {
                        console.error("Error parsing tip JSON:", tipString, e);
                    }
                });
            }

            updateEquivalents() {
                this.equivalentsList.innerHTML = "";
                const equivalentsContainer = this.equivalentsList;
                if (this.totalEmission <= 0) {
                    return this.renderEmptyState(equivalentsContainer, "insights", "Calculate emissions to see equivalents.");
                }
                let equivalentsToShow = this.EQUIVALENTS.filter(eq => this.totalEmission >= eq.min && this.totalEmission <= eq.max);
                if (equivalentsToShow.length === 0) {
                    const below = this.EQUIVALENTS.filter(eq => eq.max < this.totalEmission).sort((a, b) => b.max - a.max);
                    const above = this.EQUIVALENTS.filter(eq => eq.min > this.totalEmission).sort((a, b) => a.min - b.min);
                    if (below.length > 0) equivalentsToShow.push(below[0]);
                    if (above.length > 0 && equivalentsToShow.length < 2) equivalentsToShow.push(above[0]);
                }
                equivalentsToShow = equivalentsToShow.slice(0, 3);
                if (equivalentsToShow.length === 0) {
                     const closest = [...this.EQUIVALENTS].sort((a,b) => Math.min(Math.abs(a.min - this.totalEmission), Math.abs(a.max - this.totalEmission)) - Math.min(Math.abs(b.min - this.totalEmission), Math.abs(b.max - this.totalEmission)));
                     if(closest.length > 0) equivalentsToShow.push(closest[0]);
                }
                if (equivalentsToShow.length === 0) {
                    return this.renderEmptyState(equivalentsContainer, "scale", "No suitable equivalents match this amount.");
                }
                equivalentsToShow.forEach(eq => {
                    const listItem = this.renderTipOrEquivalentItem(eq);
                    equivalentsContainer.appendChild(listItem);
                });
            }

            checkEmptyStates() {
                const hasHistory = this.history.length > 0;
                this.pieCanvas.style.display = hasHistory ? 'block' : 'none';
                this.pieEmpty.style.display = hasHistory ? 'none' : 'block';
                this.barCanvas.style.display = hasHistory ? 'block' : 'none';
                this.barEmpty.style.display = hasHistory ? 'none' : 'block';
            }

            renderEmptyState(container, icon, text) {
                container.innerHTML = '';
                const div = document.createElement('div');
                div.className = 'empty-state center-align large-padding';
                div.innerHTML = `<i class="material-icons primary-text">${icon}</i><p class="secondary-text">${text}</p>`;
                container.appendChild(div);
            }

            // *** MODIFIED FUNCTION ***
            showResult() {
                this.resultDiv.classList.remove('surface-variant', 'error-container');
                this.resultDiv.classList.add('primary-container'); // Change background
                // Set the simple success message
                this.resultDiv.innerHTML = ` <div class="row middle-align"> <i class="material-icons right-margin">check_circle_outline</i> <span>Calculation Added!</span> </div>`;
                this.resultDiv.style.display = 'flex'; // Ensure it's visible
            }

            // *** MODIFIED FUNCTION ***
            clearResult() {
                this.resultDiv.classList.remove('primary-container', 'error-container');
                this.resultDiv.classList.add('surface-variant'); // Reset background
                // Set the default "Ready" message
                this.resultDiv.innerHTML = ` <div class="row middle-align"> <i class="material-icons right-margin">info_outline</i> <span>Ready to calculate.</span> </div>`;
                this.resultDiv.style.display = 'flex'; // Ensure it's visible
            }

            showError(message) {
                this.errorTextSpan.textContent = message;
                this.errorMessage.style.display = "flex";
                this.clearResult(); // Still good to clear the result state
                this.resultDiv.style.display = 'none'; // Hide the result div on error
            }

            hideError() {
                this.errorMessage.style.display = "none";
                this.errorTextSpan.textContent = "";
                this.clearResult(); // Reset to "Ready to calculate" state
                this.resultDiv.style.display = 'flex'; // Ensure result div is visible again
            }

            resetForm() {
                this.categorySelect.value = "";
                this.populateItems("");
                this.valueInput.value = "";
                this.amountUnitSpan.textContent = "";
                this.hideError();
                this.clearResult(); // Set back to "Ready to calculate"
                if (typeof ui === 'function') {
                    setTimeout(() => {
                        ui(this.categorySelect);
                        ui(this.itemSelect);
                    }, 0);
                }
            }

            resetCalculator() {
                if (confirm("Are you sure you want to clear all history and reset the calculator? This cannot be undone.")) {
                    this.history = [];
                    this.totalEmission = 0;
                    this.saveHistory();
                    this.resetForm(); // This calls hideError and clearResult
                    this.updateUI();
                }
            }

            saveHistory() {
                try {
                    localStorage.setItem('ecoTrackHistory', JSON.stringify(this.history));
                } catch (e) {
                    console.error("Could not save history to localStorage:", e);
                }
            }

            loadHistory() {
                try {
                    const saved = localStorage.getItem('ecoTrackHistory');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        return Array.isArray(parsed) ? parsed : [];
                    }
                    return [];
                } catch (e) {
                    console.error("Could not load or parse history from localStorage:", e);
                    localStorage.removeItem('ecoTrackHistory');
                    return [];
                }
            }

            initCharts() {
                const getCssVar = (varName) => getComputedStyle(document.body).getPropertyValue(varName).trim();
                const baseChartOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: getCssVar('--on-surface') || '#000000',
                                font: {
                                    family: "'Quicksand', sans-serif",
                                    size: 11
                                },
                                boxWidth: 20,
                                padding: 15
                            }
                        },
                        tooltip: {
                            bodyFont: { family: "'Quicksand', sans-serif" },
                            titleFont: { family: "'Quicksand', sans-serif" },
                            backgroundColor: getCssVar('--surface-container-high') || '#444444',
                            titleColor: getCssVar('--on-surface') || '#ffffff',
                            bodyColor: getCssVar('--on-surface-variant') || '#dddddd',
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null && context.chart.config.type === 'bar') {
                                        label += context.parsed.y.toFixed(2) + ' kg CO₂e';
                                    } else if (context.parsed !== null && context.chart.config.type === 'doughnut') {
                                        label += context.label + ': ' + context.parsed.toFixed(2) + ' kg CO₂e';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                };

                try {
                    const pieCtx = this.pieCanvas.getContext("2d");
                    this.pieChart = new Chart(pieCtx, {
                        type: "doughnut",
                        data: {
                            labels: [],
                            datasets: [{
                                data: [],
                                borderWidth: 2
                            }]
                        },
                        options: {
                             ...baseChartOptions,
                             plugins: {
                                ...baseChartOptions.plugins,
                                legend: {
                                    ...baseChartOptions.plugins.legend,
                                     position: "right"
                                }
                            },
                            cutout: '60%'
                        }
                    });
                } catch (e) {
                    console.error("Failed to initialize Pie Chart:", e);
                    this.pieEmpty.style.display = 'block';
                    this.pieEmpty.innerHTML = '<p class="error-text center-align small-padding">Could not load Pie Chart</p>';
                }

                try {
                    const barCtx = this.barCanvas.getContext("2d");
                    this.barChart = new Chart(barCtx, {
                        type: "bar",
                        data: {
                            labels: [],
                            datasets: [{
                                label: "kg CO₂e",
                                data: [],
                                borderWidth: 1,
                                borderRadius: 4
                            }]
                        },
                        options: {
                            ...baseChartOptions,
                             plugins: {
                                ...baseChartOptions.plugins,
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: getCssVar('--outline') || '#cccccc'
                                    },
                                    ticks: {
                                        color: getCssVar('--on-surface-variant') || '#666666',
                                        font: { family: "'Quicksand', sans-serif" }
                                    },
                                    title: {
                                        display: true,
                                        text: 'kg CO₂e',
                                        color: getCssVar('--on-surface-variant') || '#666666',
                                        font: { family: "'Quicksand', sans-serif" }
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    },
                                    ticks: {
                                        color: getCssVar('--on-surface-variant') || '#666666',
                                        font: { family: "'Quicksand', sans-serif" }
                                    }
                                }
                            }
                        }
                    });
                } catch (e) {
                    console.error("Failed to initialize Bar Chart:", e);
                    this.barEmpty.style.display = 'block';
                    this.barEmpty.innerHTML = '<p class="error-text center-align small-padding">Could not load Bar Chart</p>';
                }
                this.updateChartThemes();
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            if (typeof ui === 'undefined') {
                console.warn("BeerCSS 'ui' function not found. Dynamic elements like tooltips might not initialize correctly.");
                 try {
                    const tooltips = document.querySelectorAll('.tooltip');
                    tooltips.forEach(tooltip => {
                        const parent = tooltip.parentElement;
                        if (!parent) return;
                        parent.style.position = parent.style.position || 'relative';
                        let timeoutId;
                        parent.addEventListener('mouseenter', () => { clearTimeout(timeoutId); tooltip.style.opacity = '1'; tooltip.style.visibility = 'visible'; });
                        parent.addEventListener('mouseleave', () => { timeoutId = setTimeout(() => { tooltip.style.opacity = '0'; tooltip.style.visibility = 'hidden'; }, 100); });
                         tooltip.addEventListener('mouseenter', () => clearTimeout(timeoutId));
                        tooltip.addEventListener('mouseleave', () => { timeoutId = setTimeout(() => { tooltip.style.opacity = '0'; tooltip.style.visibility = 'hidden'; }, 100); });
                    });
                } catch (e) { console.error("Manual tooltip init failed:", e); }
            } else {
                 try {
                    ui();
                } catch (e) {
                    console.error("BeerCSS ui() function failed:", e);
                }
            }

            window.calculator = new CarbonCalculator();
             setTimeout(() => {
                if (typeof ui === 'function') {
                    try {
                        ui('#category');
                        ui('#item');
                    } catch (e) {
                        console.error("Failed to re-initialize selects with ui():", e);
                    }
                }
            }, 100);
        });
    </script>
</body>

</html>